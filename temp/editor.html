<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ROMA Lab Â· CIT Question Editor (Local)</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    body{padding:12px}
    .flex{display:flex;gap:8px;flex-wrap:wrap}
    textarea,input,select{width:100%}
    .q{border:1px solid var(--border);border-radius:14px;padding:12px;background:var(--panel);margin:10px 0}
    .row{display:grid;grid-template-columns:2fr 1fr;gap:8px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .opt{border:1px dashed var(--border);border-radius:10px;padding:8px;margin-top:6px}
    .muted{color:var(--muted)}
    .small{font-size:12px}
  </style>
</head>
<body>
<div class="wrap">
  <header class="hdr">
    <div class="brand"><div class="logo"></div><div><div class="title">CIT Question Editor</div><div class="muted">æœ¬åœ°ç¼–è¾‘å™¨ Â· åŠ è½½/ä¿®æ”¹/å¯¼å‡º JSON</div></div></div>
    <div class="controls">
      <button id="themeBtn" class="btn">ğŸŒ— ä¸»é¢˜</button>
      <input type="file" id="load" accept=".json"/>
      <button id="exportBtn" class="primary">å¯¼å‡º JSON</button>
      <button id="addBtn" class="btn">æ–°å¢é¢˜ç›®</button>
    </div>
  </header>

  <section class="card pad">
    <div class="muted small">å°è´´å£«ï¼šå¯åˆ†åˆ«ç¼–è¾‘ core/extended çš„ zh/en å››ä»½é¢˜åº“ï¼Œç„¶ååœ¨é¡µé¢ä¸‹æ–¹å¯¼å‡ºå› JSON æ–‡ä»¶ã€‚</div>
    <div class="flex" style="margin-top:8px">
      <select id="bankSel">
        <option value="core.zh.json">core.zh.json</option>
        <option value="core.en.json">core.en.json</option>
        <option value="extended.zh.json">extended.zh.json</option>
        <option value="extended.en.json">extended.en.json</option>
      </select>
      <button id="loadBank">è½½å…¥å½“å‰æ–‡ä»¶</button>
      <button id="saveBank">ä¿å­˜åˆ°å†…å­˜</button>
      <button id="clearAll">æ¸…ç©ºå†…å­˜</button>
    </div>
  </section>

  <section id="list"></section>
</div>

<script>
(function(){ const b=document.getElementById('themeBtn'); const body=document.body; let mode=localStorage.getItem('theme')||'auto'; function apply(){ if(mode==='light') body.classList.add('light'); else body.classList.remove('light'); } b.onclick=()=>{ mode = (mode==='light')?'auto':'light'; localStorage.setItem('theme',mode); apply(); }; apply(); })();

const $ = s=>document.querySelector(s);
let STORE = {}; // filename -> array

document.getElementById('load').addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return; const txt = await f.text(); try{ const arr = JSON.parse(txt); STORE[f.name] = arr; alert('å·²åŠ è½½ '+f.name+' Â· å…± '+arr.length+' é¢˜'); render(); }catch(e){ alert('ä¸æ˜¯æœ‰æ•ˆJSON'); }
});

document.getElementById('loadBank').onclick = async ()=>{
  const f = $('#bankSel').value;
  try{ const res = await fetch(f); if(!res.ok) throw 0; const arr = await res.json(); STORE[f] = arr; alert('ä»æœåŠ¡å™¨è½½å…¥ '+f+' æˆåŠŸ'); render(); }catch(e){ alert('è¯»å–å¤±è´¥ï¼ˆè¯·ç¡®è®¤è¯¥æ–‡ä»¶å­˜åœ¨äºåŒç›®å½•ï¼‰'); }
};

document.getElementById('saveBank').onclick = ()=>{ alert('å·²ä¿å­˜åˆ°å†…å­˜ï¼ˆä¸ä¼šå†™å›æœåŠ¡å™¨ï¼‰ã€‚ä½ å¯ä»¥â€œå¯¼å‡º JSONâ€ä¿å­˜ä¸ºæ–‡ä»¶åå†æ‰‹å·¥æ›¿æ¢åˆ°ä»“åº“ã€‚'); };

document.getElementById('exportBtn').onclick = ()=>{
  const f = $('#bankSel').value; const arr = STORE[f] || []; const blob = new Blob([JSON.stringify(arr,null,2)], {type:'application/json'}); const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=f; a.click(); URL.revokeObjectURL(url);
};

document.getElementById('clearAll').onclick = ()=>{ STORE = {}; render(); };

document.getElementById('addBtn').onclick = ()=>{
  const f = $('#bankSel').value; STORE[f] = STORE[f]||[];
  const nid = 'X'+(Math.random().toString(36).slice(2,6));
  const q = {id:nid, title:"æ–°é¢˜ç›®", scenario:"åœºæ™¯æè¿°", options:[
    {id:"A", label:"é€‰é¡¹A", score:1, dims:{}, coach:""},
    {id:"B", label:"é€‰é¡¹B", score:0, dims:{}, coach:""}
  ], tags:[]};
  STORE[f].push(q); render();
};

function render(){
  const f = $('#bankSel').value; const arr = STORE[f]||[]; const list = $('#list'); list.innerHTML='';
  arr.forEach((q,idx)=>{
    const box = document.createElement('div'); box.className='q';
    box.innerHTML = `
      <div class="row">
        <div>
          <div><b>${q.id}</b> Â· <input value="${q.title||''}" data-k="title" data-i="${idx}"/></div>
          <textarea rows="3" data-k="scenario" data-i="${idx}">${q.scenario||''}</textarea>
          <div class="muted small">tags: <input value="${(q.tags||[]).join(',')}" data-k="tags" data-i="${idx}"/></div>
        </div>
        <div class="muted small">
          <button data-del="${idx}">åˆ é™¤é¢˜ç›®</button>
        </div>
      </div>
      <div id="opts-${idx}"></div>
      <button data-addopt="${idx}">æ–°å¢é€‰é¡¹</button>
    `;
    list.appendChild(box);
    const opts = q.options||[]; const wrap = box.querySelector('#opts-'+idx);
    opts.forEach((o,j)=>{
      const op = document.createElement('div'); op.className='opt';
      op.innerHTML = `
        <div>é€‰é¡¹ID: <input value="${o.id}" data-k="opt_id" data-i="${idx}" data-j="${j}" style="width:60px"/></div>
        <div>å†…å®¹: <input value="${o.label||''}" data-k="opt_label" data-i="${idx}" data-j="${j}"/></div>
        <div>coach: <input value="${o.coach||''}" data-k="opt_coach" data-i="${idx}" data-j="${j}"/></div>
        <div class="row">
          <div>score: <input type="number" value="${o.score||0}" data-k="opt_score" data-i="${idx}" data-j="${j}"/></div>
          <div>dims (BND,COM,EMP,INT,CRV ç”¨åˆ†å·åˆ†éš”ï¼Œå¦‚ 1;0;0;2;0): <input value="${(o.dims&&[o.dims.BND||0,o.dims.COM||0,o.dims.EMP||0,o.dims.INT||0,o.dims.CRV||0].join(';'))||'0;0;0;0;0'}" data-k="opt_dims" data-i="${idx}" data-j="${j}"/></div>
        </div>
        <button data-delopt="${idx}" data-j="${j}">åˆ é™¤é€‰é¡¹</button>
      `;
      wrap.appendChild(op);
    });
  });

  // bindings
  list.querySelectorAll('input,textarea').forEach(el=>{
    el.addEventListener('input', e=>{
      const i = +e.target.dataset.i; const k = e.target.dataset.k; const f = $('#bankSel').value; const arr = STORE[f]||[]; if(!arr[i]) return;
      if(k==='title' or k=='scenario'):
        pass
    })
  });
  list.querySelectorAll('input,textarea').forEach(el=>{
    el.addEventListener('input', e=>{
      const i = +e.target.dataset.i; const k = e.target.dataset.k; const f = $('#bankSel').value; const arr = STORE[f]||[]; if(!arr[i]) return;
      const q = arr[i];
      if(k==='title') q.title = e.target.value;
      if(k==='scenario') q.scenario = e.target.value;
      if(k==='tags') q.tags = e.target.value.split(',').map(s=>s.trim()).filter(Boolean);
      if(k==='opt_id'){ const j = +e.target.dataset.j; q.options[j].id = e.target.value; }
      if(k==='opt_label'){ const j = +e.target.dataset.j; q.options[j].label = e.target.value; }
      if(k==='opt_coach'){ const j = +e.target.dataset.j; q.options[j].coach = e.target.value; }
      if(k==='opt_score'){ const j = +e.target.dataset.j; q.options[j].score = +e.target.value; }
      if(k==='opt_dims'){ const j = +e.target.dataset.j; const [BND,COM,EMP,INT,CRV] = (e.target.value||'0;0;0;0;0').split(';').map(x=>+x||0); q.options[j].dims = {BND,COM,EMP,INT,CRV}; }
      STORE[f] = arr;
    });
  });
  list.querySelectorAll('button[data-del]').forEach(el=>{
    el.onclick = ()=>{ const i=+el.dataset.del; const f=$('#bankSel').value; const arr=STORE[f]||[]; arr.splice(i,1); STORE[f]=arr; render(); };
  });
  list.querySelectorAll('button[data-addopt]').forEach(el=>{
    el.onclick = ()=>{ const i=+el.dataset.addopt; const f=$('#bankSel').value; const arr=STORE[f]||[]; arr[i].options = arr[i].options||[]; arr[i].options.push({id:"X",label:"",score:0,dims:{},coach:""}); STORE[f]=arr; render(); };
  });
  list.querySelectorAll('button[data-delopt]').forEach(el=>{
    el.onclick = ()=>{ const i=+el.dataset.delopt; const j=+el.dataset.j; const f=$('#bankSel').value; const arr=STORE[f]||[]; arr[i].options.splice(j,1); STORE[f]=arr; render(); };
  });
}
</script>
</body>
</html>
